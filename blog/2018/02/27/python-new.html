<html>
<head>
    <title>Ilia Zaitsev's personal site</title>
    <meta charset="utf-8"></meta>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
          integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Coda:400,800|Roboto:400,500,700|Share:400,400i,700,700i|Space+Mono:400,400i,700,700i">
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/hybrid.min.css">
    <link rel="stylesheet" href="/assets/css/site.css">
    <link rel="stylesheet" href="/assets/css/gist.css">
    <link rel="stylesheet" href="/assets/css/hsjs.css">
</head>
<body onload="setup();">
    <div class="topmost">
        <div class="image">
            <img src="/assets/img/writings.png" width="1250">
        </div>
        <div class="text">
            <div class="title">Ilia Zaitsev</div>
            <div class="subtitle">{Software Developer & AI Enthusiast}</div>
        </div>
    </div>
    <div class="nav" id="nav-site-pages">
        <ul>
            <li class="blog"><a href="/" class="active">Blog</a></li>
            <li class="projects"><a href="#">Projects</a></li>
            <li class="resume"><a href="#">Resume</a></li>
            <li class="index"><a href="#">Index</a></li>
            <li class="contact"><a href="/contact">Contact</a></li>
        </ul>
    </div>
    <div class="container post">
    <h3 class="header centered">Using Python __new__ Method to Dynamically Switch Class Implementations</h3>
    <hr />
    <div class="tags right">
        <span>tags:</span>&nbsp;python, inheritance, magic, metaclass
    </div>
    <article class="text main">
    <p>Each Python object has a set magic of methods which could be overridden to
customize instance creation and behavior. One of widely used methods is
<code class="highlighter-rouge">__init__</code>, which is used to perform newly created instance initialization.
But there is one more magic method taking part in object creation, called <code class="highlighter-rouge">__new__</code>,
which is actually <em>creates</em> class’s instance. The post explains how to use
this method to dynamically switch implementation of class methods.</p>

<!--more-->

<div class="list-of-contents">
  <h4>Post contents</h4>
  <ul></ul>
</div>

<hr class="with-margin" />

<h4 class="header" id="intro">General Information</h4>

<p>The <a href="https://docs.python.org/3/reference/datamodel.html#object.__new__">Python language reference</a>
explains the purpose of <code class="highlighter-rouge">__new__</code> method as being a special-cased static method that
takes the class <code class="highlighter-rouge">cls</code> of which an instance was required as its first argument which
should return the new object instance of that class.</p>

<p>One of the main differences of this method from <code class="highlighter-rouge">__init__</code> is that it actually
<em>creates a new instance</em>, not just binds its properties or makes some kind of
object tuning. Therefore, appropriately overridden, this method allows to
customize object creation process and, for example, switch actual implementation
of created.</p>

<p>This method allows one to create a “facade” class that declares interface, but
which implementation could be chosen at runtime, based on some criterion, i.e.
name of specific algorithm which is about to used, set of parameters, etc. This class
“hides” actual implementation and allows to use its name instead of hard-coding
a name of specific class. Talking about languages with static type systems,
one could compare (from logical point of view) this approach with coercing
specific object types to generic interface type and using it instead:</p>

<pre><code class="language-Swift">public protocol StringConvertible {
    func toString() -&gt; String
}

struct Color: StringConvertible {
  let r: Int
  let g: Int
  let b: Int  
  func toString() -&gt; String {
      return "Color(r: \(r), g: \(g), b: \(b))"
  }
}

struct Point: StringConvertible {
  let x: Float
  let y: Float
  func toString() -&gt; String {
      return "Point(x: \(x), y: \(y))"
  }
}

let convertibles: [StringConvertible] = [
    Color(r: 255, g: 0, b: 0),
    Point(x: 1.5, y: 2.5)
]
for object in convertibles {
    print(object.toString())
}
</code></pre>

<p>Next section shows a simple example which demonstrates one possible implementation
of described idea. Of course, the described example could be implemented in a lot
of different ways (i.e. callback parameter, direct inheritance, etc.), but the
main idea standing behind of this example is to show one of possible usages of
<code class="highlighter-rouge">__new__</code> method overriding.</p>

<hr class="with-margin" />

<h4 class="header" id="simple">Example: Temperature Converter</h4>

<blockquote class="tip">
<strong>TL;DR</strong>: For ones who doesn't not need too much explanations and want to navigate
right into code, here is <a href="https://gist.github.com/devforfu/1de5cecb96f92bd99ed595de7cdb7907">
a full content</a> of this example represented as a single Python file.
</blockquote>

<p>Consider the following example: one need to create a family of temperature
converter classes which would be able to convert from <a href="https://en.wikipedia.org/wiki/Kelvin">Kelvin temperature degrees</a> into different measurement scales.
All these classes should share the same set of methods, but apply different
temperature converting formulas.</p>

<p>Let’s start with showing a use case of the code we’re going to create. For example,
one could create a list of converters and apply them to a single temperature
like this:</p>

<pre><code class="language-Python">def main():
    converters = [
        TemperatureConverter(convert_to=name)
        for name in ('celsius', 'fahrenheit')]
    temperature = 300
    for converter in converters:
        string = converter.format(temperature)
        print('%s converted %sK temperature into: %s' % (
            converter.name, temperature, string
        ))

if __name__ == '__main__':
    main()
</code></pre>

<p>Which should show the following output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python main.py
CelsiusConverter converted 300K temperature into: 26.85 <span class="o">(</span>°C<span class="o">)</span>
FahrenheitConverter converted 300K temperature into: 80.33 <span class="o">(</span>°F<span class="o">)</span>
<span class="nv">$ </span>_
</code></pre></div></div>

<p>To implement dynamic algorithm dispatching using approach proposed in previous
section, one should create a base class with an overridden <code class="highlighter-rouge">__new__</code> method.
Below is shown a possible implementation of the base class which will be used to
instantiate different types of converters depending on value of <code class="highlighter-rouge">convert_to</code>
parameter:
<script src="https://gist.github.com/devforfu/828480bbfd9e12ef27d89dd96914f537.js"></script></p>

<p>See lines <strong>8-16</strong> which shows how dynamic dispatching could be implemented. The
parameter <code class="highlighter-rouge">cls</code>, mentioned at the beginning of this post, is set to one of
specific converter classes. Then, an instance of that class is created. Lines
<strong>18-20</strong> show public <code class="highlighter-rouge">convert()</code> method that makes some basic sanity check
of provided temperature value and then calls “protected” method <code class="highlighter-rouge">_convert()</code> that
should be overridden in derived classes.</p>

<p>Now, it is time to write implementations of aforementioned specific classes. Note
that <code class="highlighter-rouge">_CelsiusConverter</code> class is written like one usually creates derived classes
in Python by explicit derivation from the base class. But <code class="highlighter-rouge">_FahrenheitConverter</code>
does not inherit from <code class="highlighter-rouge">TemperatureConverter</code> and is registered as a subclass via
<code class="highlighter-rouge">ABCMeta.register</code> method (line <strong>37</strong>). Though in this case, as soon as classes are not related,
default implementations of required methods are not available anymore and should
be written from scratch.</p>

<script src="https://gist.github.com/devforfu/eeab965f571517b2645a839768a2469a.js"></script>

<p>This example shows flexibility of duck typing where one could write their own
classes and plug-in them it into hierarchy. Just need to be sure that <code class="highlighter-rouge">__new__</code>
method can handle appropriately adding side extensions, i.e. use some
kind of registry or lookup instead of implicit enumeration of all cases using
<code class="highlighter-rouge">if-else</code> clauses. Also, one could override <code class="highlighter-rouge">__init__</code> magic methods in derived
classes to allow custom arguments, specific for their computations logic.
The following section uses dictionary lookup instead of hardcoding class names
and specific initializers.</p>

<hr class="with-margin" />

<h4 class="header" id="notifications">Dictionary Lookup of Registered Classes</h4>

<blockquote class="tip">
<strong>TL;DR</strong>: Again,
<a href="https://gist.github.com/devforfu/63fa7efe18133dc12f12a2e9ecbe9db4">
here is a link</a> to the source code discussed below.
</blockquote>

<p>This example shows almost the same approach as previously, but with more realistic
example I had in practice. Consider one needs to implement a class that would
extract user’s notification messages from server. But before implementing actual
server API (and later for purposes of brining new functionality and running
regression tests) one wants to build a testing implementation which reads locally
stored file with notifications and returns its content parsed into appropriate
format. Then, to switch between two different implementations, one just needs to pass
different configuration dictionaries like <code class="highlighter-rouge">NotificationsDispatcher(**test_config)</code>
to create an appropriate dispatcher’s instance.</p>

<p>The base notification dispatcher class could be implemented as follows:</p>

<pre><code class="language-Python">class NotificationsDispatcher(metaclass=abc.ABCMeta):
    """
    Class that retrieves a list of notifications for a specific user.
    Usually, notifications are retrieved from the remote server, but for testing
    purposes and local runs it supports reading messages from local source.
    """

    def __new__(cls, user_id: int, method: str='http', **kwargs):      
        if issubclass(cls, NotificationsDispatcher):
            cls = get_dispatcher(method)
        return object.__new__(cls)

    def __init__(self, user_id: int, dateformat='%m/%d/%Y %H:%M:%S', **kwargs):
        self.user_id = user_id
        self.dateformat = dateformat

    @abc.abstractmethod
    def get_notifications(self):
        pass
</code></pre>

<p>See that this time, as it was already noted, instead of exhaustive
<code class="highlighter-rouge">if-else</code> chain we use a helper function that looks up <code class="highlighter-rouge">method</code> name in registry
and returns appropriate class object (if it exists). This approach allows to write
 plugins in some other modules and register them via publicly exposed interface:</p>

<pre><code class="language-Python"># somewhere dictionary of dispatchers exists
from weakref import WeakValueDictionary
_dispatchers = WeakValueDictionary()

def get_dispatcher(name):
    """
    Public API to access dictionary with registered dispatchers.
    """
    if name not in _dispatchers:
        raise ValueError('dispatcher with name \'%s\' is not found' % name)
    return _dispatchers[name]

def register_dispatcher(name, cls):
    """
    Public API which is used to register new dispatcher class.
    """
    global _dispatchers
    _dispatchers[name] = cls

register_dispatcher('local', _LocalDispatcher)
register_dispatcher('http')
</code></pre>

<p>Also, as it is shown <a href="https://gist.github.com/devforfu/63fa7efe18133dc12f12a2e9ecbe9db4#file-new_involved-py-L58">here</a> and <a href="https://gist.github.com/devforfu/63fa7efe18133dc12f12a2e9ecbe9db4#file-new_involved-py-L92">there</a>,
one could override <code class="highlighter-rouge">__init__</code> methods to accept different set of arguments, depending on actual class’s implementation. For example, local notifications dispatcher requires filename, but remote one
requires server URL.</p>

<hr class="with-margin" />

<h4 class="header" id="pandas">Real World Example from Pandas Library</h4>

<p>In conclusion of this discussion, a real world example of described technique could be found in <a href="https://github.com/pandas-dev/pandas/blob/master/pandas/io/excel.py#L853-L875">Pandas library repository</a>.
In the library, there are a couple of classes responsible for writing dataframes
into Excel files. The abstract class called <code class="highlighter-rouge">ExcelWriter</code>, which simplified conceptual
representation is shown below, overrides <code class="highlighter-rouge">__new__</code> method to pick an appropriate
Excel writing library depending on provided file extension, i.e. <strong>.xls</strong> or
<strong>.xlsx</strong> format:</p>

<pre><code class="language-Python">class ExcelWriter(meta=abc.ABCMeta):
    """
    A simplified version of pandas.ExcelWriter __new__ implementation.
    """

    def __new__(cls, path, engine=None, **kwargs):
        if subclass(cls, ExcelWriter):
            if engine is None:
                ext = 'xlsx'
            try:
                engine = config.get_option('io.excel.%s.writer' % ext)
            except KeyError:
                raise ValueError('No engine for filetype: %s' % ext)
            cls = get_writer(engine)
        return object.__new__(cls)

    @abc.abstractproperty
    def engine(self):
        pass

    @abc.abstractmethod
    def write_cells(self, cells, sheet_name=None, startrow=0, startcol=0,
                    freeze_panes=None):
        pass

    # other interface methods and properties ...
</code></pre>

<hr class="with-margin" />

<h4 class="header" id="conclusion">Conclusion</h4>

<p>A dynamic nature of Python’s type system allows not only to override methods
and bind new attributes to object, but also to completely substitute appropriate
class implementation in runtime based on configuration parameters. Quite often
the same result could be achieved using composition instead of inheritance or
using callback functions. But, if used appropriately, the discussed approach allows to
clearly separate different implementations from each other while keeping same interface
and class name, switching only configuration parameters.</p>

<hr class="with-margin" />

<h3 id="references">References</h3>

<ol>
  <li><a href="https://docs.python.org/3/reference/datamodel.html">Python Data Model Documentation</a></li>
  <li><a href="https://github.com/pandas-dev/pandas">Pandas Repository</a></li>
</ol>

    </article>
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = "/blog/2018/02/27/python-new";
        this.page.identifier = "1";
        this.page.title = "Using Python __new__ Method to Dynamically Switch Class Implementations";
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//iliazaitsev-me.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    <footer class="footer">
        Ilia Zaitsev, 2017-2018
    </footer>
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"
            integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n"
            crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
            integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
            crossorigin="anonymous">
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
            integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
            crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/swift.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script>
    <script src="/lib/site.js"></script>
</body>
</html>
